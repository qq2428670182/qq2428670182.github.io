<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="java,Futari,livemylife,IT  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- gitment start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css"/>
      <!-- gitment end -->
    

    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://www.sfhjavaer.tech/undefined/Nacos和Ribbon小记/">
  <title>
    
      Nacos和Ribbon小记 - 一入Java深似海
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Live My Life</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('');
      --intro-header-background-image-url-page: url('/img/header_img/archive_bg2.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/archive_bg2.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url(''); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
            </div>
            <h1>Nacos和Ribbon小记</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by Futari on
              2023-01-19
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">5</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">1.6k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h4 id="引入注册中心Nacos"><a href="#引入注册中心Nacos" class="headerlink" title="引入注册中心Nacos"></a>引入注册中心Nacos</h4><p>Cloud提供了一个类DiscoveryClient作为注册发现中心的客户端，用于Client端对注册中心服务的查询，导入包之后直接Autowired即可，注意是Cloud提供的，即使不使用nacos，使用其他的注册中心，这个Api同样可用。</p>
<blockquote>
<p>常用的方法有getInstances(String 服务名即serviceId) 和 getServices(String serviceId)，查询实例信息</p>
</blockquote>
<h6 id="指定Nacos元数据除了可以在控制台console上直接编写键值对以外，还可以在application-yml中配置metadata属性，如果version-：-v1或者在console上version-v1都随意，只是代表元信息。"><a href="#指定Nacos元数据除了可以在控制台console上直接编写键值对以外，还可以在application-yml中配置metadata属性，如果version-：-v1或者在console上version-v1都随意，只是代表元信息。" class="headerlink" title="指定Nacos元数据除了可以在控制台console上直接编写键值对以外，还可以在application.yml中配置metadata属性，如果version ： v1或者在console上version = v1都随意，只是代表元信息。"></a>指定Nacos元数据除了可以在控制台console上直接编写键值对以外，还可以在application.yml中配置metadata属性，如果version ： v1或者在console上version = v1都随意，只是代表元信息。</h6><h4 id="手写负载均衡（随机法）"><a href="#手写负载均衡（随机法）" class="headerlink" title="手写负载均衡（随机法）"></a>手写负载均衡（随机法）</h4><p>JUC包下的ThreadLocalRandom可以在多线程并发情况下生成随机数，减少竞争提升性能，生成方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> randomNum = ThreadLocalRandom.current().nextInt(max = (服务量list的size()));</span><br></pre></td></tr></table></figure>
<p>拿到该服务的地址发送http通信请求即可。</p>
<h4 id="Ribben核心组成"><a href="#Ribben核心组成" class="headerlink" title="Ribben核心组成"></a>Ribben核心组成</h4><p><img src="Snipaste_2023-02-19_18-13-01.png" alt="Snipaste_2023-02-19_18-13-01.png"></p>
<h5 id="Ribben自带负载均衡策略"><a href="#Ribben自带负载均衡策略" class="headerlink" title="Ribben自带负载均衡策略"></a>Ribben自带负载均衡策略</h5><p><img src="Snipaste_2023-02-19_18-17-53.png" alt="Snipaste_2023-02-19_18-17-53.png"></p>
<h6 id="可以看到Ribben是没有基于权重的负载均衡规则的，我们想要使用0-1权重范围的负载均衡需要借助nacos构建，至于为什么没有。是因为要符合Cloud规范。"><a href="#可以看到Ribben是没有基于权重的负载均衡规则的，我们想要使用0-1权重范围的负载均衡需要借助nacos构建，至于为什么没有。是因为要符合Cloud规范。" class="headerlink" title="可以看到Ribben是没有基于权重的负载均衡规则的，我们想要使用0-1权重范围的负载均衡需要借助nacos构建，至于为什么没有。是因为要符合Cloud规范。"></a>可以看到Ribben是没有基于权重的负载均衡规则的，我们想要使用0-1权重范围的负载均衡需要借助nacos构建，至于为什么没有。是因为要符合Cloud规范。</h6><h3 id="重点-Ribben的负载均衡策略的细粒度和全局配置"><a href="#重点-Ribben的负载均衡策略的细粒度和全局配置" class="headerlink" title="(重点) Ribben的负载均衡策略的细粒度和全局配置"></a>(重点) Ribben的负载均衡策略的细粒度和全局配置</h3><h6 id="配置方式一共有两种，Java代码配置和配置文件属性配置"><a href="#配置方式一共有两种，Java代码配置和配置文件属性配置" class="headerlink" title="配置方式一共有两种，Java代码配置和配置文件属性配置"></a>配置方式一共有两种，Java代码配置和配置文件属性配置</h6><p>后者最为简单，直接修改以下属性为对应的策略类的类路径即可，如</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;clientName&gt;.ribbon.NFLoadBalanceRuleClassName</span> <span class="string">:</span> <span class="string">com.........</span></span><br></pre></td></tr></table></figure>
<p>对于Java代码的全局配置，需要把JavaConfig中的@RibbonClient注解修改为@RibbonClients(不再配置name属性，仅配置defaultConfiguration)</p>
<h4 id="关于Java配置方式"><a href="#关于Java配置方式" class="headerlink" title="关于Java配置方式 "></a><font color = "red">关于Java配置方式 </font></h4><h6 id="（1）在Application层级下创建JavaConfig，确定具体规则"><a href="#（1）在Application层级下创建JavaConfig，确定具体规则" class="headerlink" title="（1）在Application层级下创建JavaConfig，确定具体规则"></a>（1）在Application层级下创建JavaConfig，确定具体规则</h6><h6 id="（2）细粒度的负载均衡规则配置：在SpringApplication启动类目录之外创建JavaConfig类"><a href="#（2）细粒度的负载均衡规则配置：在SpringApplication启动类目录之外创建JavaConfig类" class="headerlink" title="（2）细粒度的负载均衡规则配置：在SpringApplication启动类目录之外创建JavaConfig类."></a>（2）细粒度的负载均衡规则配置：在SpringApplication启动类目录之外创建JavaConfig类.</h6><h6 id="（3）然后该类添加-RibbonClient-name-“服务名来确定细粒度”-configuration-Application层级内创建的具体规则类-class-注解。"><a href="#（3）然后该类添加-RibbonClient-name-“服务名来确定细粒度”-configuration-Application层级内创建的具体规则类-class-注解。" class="headerlink" title="（3）然后该类添加@RibbonClient(name = “服务名来确定细粒度”,configuration = Application层级内创建的具体规则类.class)注解。"></a>（3）然后该类添加@RibbonClient(name = “服务名来确定细粒度”,configuration = Application层级内创建的具体规则类.class)注解。</h6><h4 id="为什么要这样设置？？？？为什么要将最终的JavaConfig放到外面，这样不就扫描不到了吗？"><a href="#为什么要这样设置？？？？为什么要将最终的JavaConfig放到外面，这样不就扫描不到了吗？" class="headerlink" title="为什么要这样设置？？？？为什么要将最终的JavaConfig放到外面，这样不就扫描不到了吗？"></a><font color = "blue">为什么要这样设置？？？？为什么要将最终的JavaConfig放到外面，这样不就扫描不到了吗</font>？</h4><blockquote>
<p>原因是Spring的内部规则导致，我们在传统SSM框架中一般会用XML方式分别引入Spring和SpringMVC的依赖，并且会确定好其范围，Spring如下，不扫描Controller</p>
</blockquote>
<p><img src="Snipaste_2023-02-19_18-43-22.png" alt="Snipaste_2023-02-19_18-43-22.png"></p>
<h5 id="而MVC的恰好相反："><a href="#而MVC的恰好相反：" class="headerlink" title="而MVC的恰好相反："></a>而MVC的恰好相反：</h5><p><img src="Snipaste_2023-02-19_18-45-10.png" alt="Snipaste_2023-02-19_18-45-10.png"></p>
<h5 id="这里又涉及到-ComponentScan，他会扫描Component并构建对应的规则树，如果两个拥有独立树的组件没有被分开单独处理，那么树交叉（上下文重叠）就有可能会产生各种错误，所以不要让Spring扫描到Ribbon"><a href="#这里又涉及到-ComponentScan，他会扫描Component并构建对应的规则树，如果两个拥有独立树的组件没有被分开单独处理，那么树交叉（上下文重叠）就有可能会产生各种错误，所以不要让Spring扫描到Ribbon" class="headerlink" title="这里又涉及到@ComponentScan，他会扫描Component并构建对应的规则树，如果两个拥有独立树的组件没有被分开单独处理，那么树交叉（上下文重叠）就有可能会产生各种错误，所以不要让Spring扫描到Ribbon"></a>这里又涉及到@ComponentScan，他会扫描Component并构建对应的规则树，如果两个拥有独立树的组件没有被分开单独处理，那么树交叉（上下文重叠）就有可能会产生各种错误，所以不要让Spring扫描到Ribbon</h5><h6 id="这里假如把Ribbon类放入扫描范围内会怎么样呢？"><a href="#这里假如把Ribbon类放入扫描范围内会怎么样呢？" class="headerlink" title="这里假如把Ribbon类放入扫描范围内会怎么样呢？"></a>这里假如把Ribbon类放入扫描范围内会怎么样呢？</h6><p>结果是会将细粒度配置变为全局配置，但是建议直接使用全局配置，因为由于树（上下文）重叠产生的效果强烈不推荐。</p>
<h4 id="最后总结下配置方式对比："><a href="#最后总结下配置方式对比：" class="headerlink" title="最后总结下配置方式对比："></a>最后总结下配置方式对比：</h4><p><img src="Snipaste_2023-02-19_18-46-03.png" alt="Snipaste_2023-02-19_18-46-03.png"></p>
<p><img src="Snipaste_2023-02-19_18-47-01.png" alt="Snipaste_2023-02-19_18-47-01.png"></p>
<p>PS：因为配置规则IRule只是Ribbon的其中一个配置项（组成部分）也就是均衡规则，其他的配置项同样都可以使用JavaConfig（@Bean返回对应配置项的实现类即可，注意大配置项反映到代码中是一个接口）和属性配置（有对应的属性名）</p>
<h4 id="开启Ribbon饥饿加载"><a href="#开启Ribbon饥饿加载" class="headerlink" title="开启Ribbon饥饿加载"></a>开启Ribbon饥饿加载</h4><p>因为Ribbon第一次对某一个服务发起请求时，会创建对应服务名的RibbonClient，所以默认是懒加载，如果我们要开启饥饿加载，如下：</p>
<h6 id="逗号分隔多个服务名"><a href="#逗号分隔多个服务名" class="headerlink" title="逗号分隔多个服务名"></a>逗号分隔多个服务名</h6><p><img src="Snipaste_2023-02-19_23-00-57.png" alt="Snipaste_2023-02-19_23-00-57.png"></p>
<h4 id="实现Ribbon调用同集群实例优先（容灾）"><a href="#实现Ribbon调用同集群实例优先（容灾）" class="headerlink" title="实现Ribbon调用同集群实例优先（容灾）"></a>实现Ribbon调用同集群实例优先（容灾）</h4><p>同样是要实现负载均衡算法IRule接口的子抽象类，为什么是抽象类实现接口？</p>
<blockquote>
<p><strong>抽象</strong>类当然能够实现接口，意义如下：一般来说我们使用普通类来实现接口，这个普通类就必须实现接口中所有的方法，这样的结果就是普通类中就需要实现多余的方法，造成代码冗余。 但是如果我们使用的是抽象类来实现接口，那么就可以只实现接口中的部分方法，并且当其他类继承这个抽象类时，仍然可以实现接口中有但抽象类并未实现的抽象方法。</p>
</blockquote>
<p>重写抽象类的choose方法的负载均衡规则，思路在下：</p>
<blockquote>
<p>首先找到指定服务的所有实例    A</p>
<p>然后过滤出同一个Cluster的所有实例      B</p>
<p>如果B是空，那么用A，然后用权重算法，最终selectOne</p>
</blockquote>
<p>获取请求的微服务名称，因为目标Uri是我们发送的网址（中间是服务名），所以获取时需要通过一个类(LoadBalancer)，该类没有getName方法，所以一般要强转乘BaseLoadBalancer，获取当前的name之后我们要传给后面的select查询。</p>
<p>如下：</p>
<p>获取所有实例还有NacosDiscoveryProperties.namingServiceInstance()方法去获取服务的所有API得到NamingService对象,注意获取这个对象是固定的，即：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NamingService service  = NacosDiscoveryProperties.namingServiceInstance();<span class="comment">//固定获取</span></span><br><span class="line"></span><br><span class="line">service.selectInstances(服务名，<span class="keyword">true</span>);<span class="comment">// 获取所有实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//即通过namingService.selectInstances(String name,boolean health)获取实例</span></span><br></pre></td></tr></table></figure>
<p>PS：前面因为Cluster是自己用配置文件指定的，所以我们还是要借助Nacos的Api为NacosDiscoveryProperties.getClusterName()，获取集群名称是为了和后面获取的所有instance逐个比较，如果请求集群和目标实例集群相同，那么才能过滤出所需要的同一cluster的目标Client服务。</p>
<blockquote>
<p>因为基于权重的算法是位于Nacos之内是固定的传入所有的实例列表，所以我们自创这个集群调度算法，需要过滤出来LIst<instance>之后，自己去引用Nacos算法，所以一般会自己创建一个类，然后去继承Nacos去调这个目标方法，把list参数传入重写方法即可。</p>
</blockquote>
<font color = "red">所以我们可以利用服务的属性来进行合理的筛选，来实现特定服务的调度，比如使用元空间属性，获取这个键值对存到Map中，如果kv相等那么我们可以实现同版本调度，比如v1仅调用v1，v2仅调用v2版本的服务</font>

<h6 id="nameSpace的作用很容易理解，就是实现了命名空间的隔离，不可跨空间调用"><a href="#nameSpace的作用很容易理解，就是实现了命名空间的隔离，不可跨空间调用" class="headerlink" title="nameSpace的作用很容易理解，就是实现了命名空间的隔离，不可跨空间调用"></a>nameSpace的作用很容易理解，就是实现了命名空间的隔离，不可跨空间调用</h6>

        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/undefined/Cloud Alibaba从入门到进阶/" data-toggle="tooltip" data-placement="top" title="Cloud Alibaba从入门到进阶">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/cn/景区抢票平台爬虫以及对美团的破解思路/" data-toggle="tooltip" data-placement="top" title="景区抢票平台爬虫以及对美团的破解思路">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=Nacos和Ribbon小记&body=Hi,I found this website and thought you might like it http://www.sfhjavaer.tech/undefined/Nacos和Ribbon小记/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->


<!-- 2. gitment comment -->

  <!-- gitment start -->
  <!-- Docs:https://github.com/imsun/gitment -->

  <div id="blog_comments"></div>
  <!-- <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"> <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script> -->

  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script>

  <script>
    const myTheme = {
      render(state, instance) {
        const container = document.createElement('div')
        container.lang = "en-US"
        container.className = 'gitment-container gitment-root-container'

        // your custom component
        container.appendChild(instance.renderSomething(state, instance))
        container.appendChild(instance.renderHeader(state, instance))
        container.appendChild(instance.renderEditor(state, instance))
        container.appendChild(instance.renderComments(state, instance))
        container.appendChild(instance.renderFooter(state, instance))
        return container
      },
      renderSomething(state, instance) {
        const container = document.createElement('div')
        container.lang = "en-US"
        container.className = 'hello_visitor'
        if (state.user.login) {
          container.innerText = `Hello ${state.user.login}, Welcome to comment system`
        }
        return container
      }
    }

    const gitment = new Gitment({
      id: 'Thu Jan 19 2023 18:16:12 GMT+0800', // optional
      owner: 'SFHJavaer',
      repo: 'SFHJavaer',
      oauth: {
        client_id: 'beed42a108cae24cf4a7',
        client_secret: '8576330fb6385d5fd5dc0c2770869a07310aa3e5'
      },
      desc: '',
      perPage: '10',
      maxCommentHeight: '250',
      theme: myTheme,
      // ... For more available options, check out the documentation below
    })

    gitment.render('blog_comments')
    // or gitment.render(document.getElementById('comments')) or document.body.appendChild(gitment.render())
  </script>

  <!-- gitment end -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BC%95%E5%85%A5%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83Nacos"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">引入注册中心Nacos</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E6%8C%87%E5%AE%9ANacos%E5%85%83%E6%95%B0%E6%8D%AE%E9%99%A4%E4%BA%86%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%8E%A7%E5%88%B6%E5%8F%B0console%E4%B8%8A%E7%9B%B4%E6%8E%A5%E7%BC%96%E5%86%99%E9%94%AE%E5%80%BC%E5%AF%B9%E4%BB%A5%E5%A4%96%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8application-yml%E4%B8%AD%E9%85%8D%E7%BD%AEmetadata%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%A6%82%E6%9E%9Cversion-%EF%BC%9A-v1%E6%88%96%E8%80%85%E5%9C%A8console%E4%B8%8Aversion-v1%E9%83%BD%E9%9A%8F%E6%84%8F%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%BB%A3%E8%A1%A8%E5%85%83%E4%BF%A1%E6%81%AF%E3%80%82"><span class="toc-nav-number">1.0.1.</span> <span class="toc-nav-text">指定Nacos元数据除了可以在控制台console上直接编写键值对以外，还可以在application.yml中配置metadata属性，如果version ： v1或者在console上version &#x3D; v1都随意，只是代表元信息。</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%89%8B%E5%86%99%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%88%E9%9A%8F%E6%9C%BA%E6%B3%95%EF%BC%89"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">手写负载均衡（随机法）</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Ribben%E6%A0%B8%E5%BF%83%E7%BB%84%E6%88%90"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Ribben核心组成</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Ribben%E8%87%AA%E5%B8%A6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Ribben自带负载均衡策略</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0Ribben%E6%98%AF%E6%B2%A1%E6%9C%89%E5%9F%BA%E4%BA%8E%E6%9D%83%E9%87%8D%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%A7%84%E5%88%99%E7%9A%84%EF%BC%8C%E6%88%91%E4%BB%AC%E6%83%B3%E8%A6%81%E4%BD%BF%E7%94%A80-1%E6%9D%83%E9%87%8D%E8%8C%83%E5%9B%B4%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9C%80%E8%A6%81%E5%80%9F%E5%8A%A9nacos%E6%9E%84%E5%BB%BA%EF%BC%8C%E8%87%B3%E4%BA%8E%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E6%9C%89%E3%80%82%E6%98%AF%E5%9B%A0%E4%B8%BA%E8%A6%81%E7%AC%A6%E5%90%88Cloud%E8%A7%84%E8%8C%83%E3%80%82"><span class="toc-nav-number">3.1.1.</span> <span class="toc-nav-text">可以看到Ribben是没有基于权重的负载均衡规则的，我们想要使用0-1权重范围的负载均衡需要借助nacos构建，至于为什么没有。是因为要符合Cloud规范。</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%87%8D%E7%82%B9-Ribben%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E7%9A%84%E7%BB%86%E7%B2%92%E5%BA%A6%E5%92%8C%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-nav-number"></span> <span class="toc-nav-text">(重点) Ribben的负载均衡策略的细粒度和全局配置</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%E4%B8%80%E5%85%B1%E6%9C%89%E4%B8%A4%E7%A7%8D%EF%BC%8CJava%E4%BB%A3%E7%A0%81%E9%85%8D%E7%BD%AE%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-nav-number">0.0.1.</span> <span class="toc-nav-text">配置方式一共有两种，Java代码配置和配置文件属性配置</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8EJava%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">关于Java配置方式 </span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%EF%BC%881%EF%BC%89%E5%9C%A8Application%E5%B1%82%E7%BA%A7%E4%B8%8B%E5%88%9B%E5%BB%BAJavaConfig%EF%BC%8C%E7%A1%AE%E5%AE%9A%E5%85%B7%E4%BD%93%E8%A7%84%E5%88%99"><span class="toc-nav-number">1.0.1.</span> <span class="toc-nav-text">（1）在Application层级下创建JavaConfig，确定具体规则</span></a></li><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%EF%BC%882%EF%BC%89%E7%BB%86%E7%B2%92%E5%BA%A6%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%EF%BC%9A%E5%9C%A8SpringApplication%E5%90%AF%E5%8A%A8%E7%B1%BB%E7%9B%AE%E5%BD%95%E4%B9%8B%E5%A4%96%E5%88%9B%E5%BB%BAJavaConfig%E7%B1%BB"><span class="toc-nav-number">1.0.2.</span> <span class="toc-nav-text">（2）细粒度的负载均衡规则配置：在SpringApplication启动类目录之外创建JavaConfig类.</span></a></li><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%EF%BC%883%EF%BC%89%E7%84%B6%E5%90%8E%E8%AF%A5%E7%B1%BB%E6%B7%BB%E5%8A%A0-RibbonClient-name-%E2%80%9C%E6%9C%8D%E5%8A%A1%E5%90%8D%E6%9D%A5%E7%A1%AE%E5%AE%9A%E7%BB%86%E7%B2%92%E5%BA%A6%E2%80%9D-configuration-Application%E5%B1%82%E7%BA%A7%E5%86%85%E5%88%9B%E5%BB%BA%E7%9A%84%E5%85%B7%E4%BD%93%E8%A7%84%E5%88%99%E7%B1%BB-class-%E6%B3%A8%E8%A7%A3%E3%80%82"><span class="toc-nav-number">1.0.3.</span> <span class="toc-nav-text">（3）然后该类添加@RibbonClient(name &#x3D; “服务名来确定细粒度”,configuration &#x3D; Application层级内创建的具体规则类.class)注解。</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%99%E6%A0%B7%E8%AE%BE%E7%BD%AE%EF%BC%9F%EF%BC%9F%EF%BC%9F%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%B0%86%E6%9C%80%E7%BB%88%E7%9A%84JavaConfig%E6%94%BE%E5%88%B0%E5%A4%96%E9%9D%A2%EF%BC%8C%E8%BF%99%E6%A0%B7%E4%B8%8D%E5%B0%B1%E6%89%AB%E6%8F%8F%E4%B8%8D%E5%88%B0%E4%BA%86%E5%90%97%EF%BC%9F"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">为什么要这样设置？？？？为什么要将最终的JavaConfig放到外面，这样不就扫描不到了吗？</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%80%8CMVC%E7%9A%84%E6%81%B0%E5%A5%BD%E7%9B%B8%E5%8F%8D%EF%BC%9A"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">而MVC的恰好相反：</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%BF%99%E9%87%8C%E5%8F%88%E6%B6%89%E5%8F%8A%E5%88%B0-ComponentScan%EF%BC%8C%E4%BB%96%E4%BC%9A%E6%89%AB%E6%8F%8FComponent%E5%B9%B6%E6%9E%84%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84%E8%A7%84%E5%88%99%E6%A0%91%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%A4%E4%B8%AA%E6%8B%A5%E6%9C%89%E7%8B%AC%E7%AB%8B%E6%A0%91%E7%9A%84%E7%BB%84%E4%BB%B6%E6%B2%A1%E6%9C%89%E8%A2%AB%E5%88%86%E5%BC%80%E5%8D%95%E7%8B%AC%E5%A4%84%E7%90%86%EF%BC%8C%E9%82%A3%E4%B9%88%E6%A0%91%E4%BA%A4%E5%8F%89%EF%BC%88%E4%B8%8A%E4%B8%8B%E6%96%87%E9%87%8D%E5%8F%A0%EF%BC%89%E5%B0%B1%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E4%BA%A7%E7%94%9F%E5%90%84%E7%A7%8D%E9%94%99%E8%AF%AF%EF%BC%8C%E6%89%80%E4%BB%A5%E4%B8%8D%E8%A6%81%E8%AE%A9Spring%E6%89%AB%E6%8F%8F%E5%88%B0Ribbon"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">这里又涉及到@ComponentScan，他会扫描Component并构建对应的规则树，如果两个拥有独立树的组件没有被分开单独处理，那么树交叉（上下文重叠）就有可能会产生各种错误，所以不要让Spring扫描到Ribbon</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E8%BF%99%E9%87%8C%E5%81%87%E5%A6%82%E6%8A%8ARibbon%E7%B1%BB%E6%94%BE%E5%85%A5%E6%89%AB%E6%8F%8F%E8%8C%83%E5%9B%B4%E5%86%85%E4%BC%9A%E6%80%8E%E4%B9%88%E6%A0%B7%E5%91%A2%EF%BC%9F"><span class="toc-nav-number">2.2.1.</span> <span class="toc-nav-text">这里假如把Ribbon类放入扫描范围内会怎么样呢？</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%9C%80%E5%90%8E%E6%80%BB%E7%BB%93%E4%B8%8B%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94%EF%BC%9A"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">最后总结下配置方式对比：</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BC%80%E5%90%AFRibbon%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">开启Ribbon饥饿加载</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E9%80%97%E5%8F%B7%E5%88%86%E9%9A%94%E5%A4%9A%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%90%8D"><span class="toc-nav-number">4.0.1.</span> <span class="toc-nav-text">逗号分隔多个服务名</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0Ribbon%E8%B0%83%E7%94%A8%E5%90%8C%E9%9B%86%E7%BE%A4%E5%AE%9E%E4%BE%8B%E4%BC%98%E5%85%88%EF%BC%88%E5%AE%B9%E7%81%BE%EF%BC%89"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">实现Ribbon调用同集群实例优先（容灾）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#nameSpace%E7%9A%84%E4%BD%9C%E7%94%A8%E5%BE%88%E5%AE%B9%E6%98%93%E7%90%86%E8%A7%A3%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%AE%9E%E7%8E%B0%E4%BA%86%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%9A%84%E9%9A%94%E7%A6%BB%EF%BC%8C%E4%B8%8D%E5%8F%AF%E8%B7%A8%E7%A9%BA%E9%97%B4%E8%B0%83%E7%94%A8"><span class="toc-nav-number">5.0.1.</span> <span class="toc-nav-text">nameSpace的作用很容易理解，就是实现了命名空间的隔离，不可跨空间调用</span></a></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://SFHJavaer.github.io/" target="_blank">Futari</a>
          </li>
          
          <li>
            <a href="http://beantech.org" target="_blank">Bean Tech</a>
          </li>
          
          <li>
            <a href="http://huangxuan.me" target="_blank">Hux Blog</a>
          </li>
          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/SFHJavaer">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://twitter.com/SFHJavaer">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://www.instagram.com/SFHJavaer">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          
            <li>
              <a target="_blank" href="http://weibo.com/SFHJavaer">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          SFHJavaer
          2023
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://www.sfhjavaer.tech/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
